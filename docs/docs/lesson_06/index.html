<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Урок 6. Собираем аналитику при помощи Botan (неактуально)
| Пишем ботов для Telegram на языке Python</title><link rel=stylesheet href=/test-web/css/override.css><link rel=stylesheet href=/telegram-tutorial/book.min.b7d5ee4f671b06dde5fd61ab409a54048ba7759e99fed39ac32a7be45d4d92cd.css><meta property=og:title content="Пишем ботов для Telegram на языке Python"><meta property=og:image content=https://telegram.org/file/811140058/2/7GzMJk4Ij54/a1649c56fa9f805828><meta property=og:description content="Учебник для ботописателей"><link rel=icon href=/telegram-tutorial/favicon.png type=image/x-icon></head><body><input type=checkbox style=display:none id=menu-control><main class="flex container"><aside class="book-menu fixed"><nav><h2 class=book-brand><a href=https://mastergroosha.github.io/telegram-tutorial/>Пишем ботов для Telegram на языке Python</a></h2><style>nav ul a[href$=\2ftelegram-tutorial\2f docs\2flesson_06\2f ]{color:#004ed0}</style><ul><li><a href=/telegram-tutorial/docs/lesson_00/>Урок 0. Подготовка рабочего места в Windows и Linux. Virtual Environment (venv). Ответы на вопросы</a></li><li><a href=/telegram-tutorial/docs/lesson_01/>Урок 1. Введение, простой echo-бот</a></li><li><a href=/telegram-tutorial/docs/lesson_02/>Урок 2. “Угадай мелодию”. Подготовка</a></li><li><a href=/telegram-tutorial/docs/lesson_03/>Урок 3. “Угадай мелодию”. Завершаем бота</a></li><li><a href=/telegram-tutorial/docs/lesson_04/>Урок 4. Вебхуки</a></li><li><a href=/telegram-tutorial/docs/lesson_05/>Урок 5. Автопостинг в каналы</a></li><li><a href=/telegram-tutorial/docs/lesson_06/>Урок 6. Собираем аналитику при помощи Botan</a></li><li><a href=/telegram-tutorial/docs/lesson_07/>Урок 7. Встраиваемые боты (Inline)</a></li><li><a href=/telegram-tutorial/docs/lesson_08/>Урок 8. Bot API v2: Кнопки и редактирование сообщений</a></li><li><a href=/telegram-tutorial/docs/lesson_09/>Урок 9. Bot API v2: Специальные кнопки, опять редактирование сообщений, кэшированный инлайн</a></li><li><a href=/telegram-tutorial/docs/lesson_10/>Урок 10. Bot API v3. Автоматизируем работу в группах</a></li><li><a href=/telegram-tutorial/docs/lesson_11/>Урок 11. Ведём (более-менее) осмысленные диалоги. Конечные автоматы</a></li><li><a href=/telegram-tutorial/docs/lesson_12/>Урок 12. Запускаем несколько ботов на одном сервере</a></li><li><a href=/telegram-tutorial/docs/lesson_13/>Урок 13. Опросы v2.0</a></li><li><a href=/telegram-tutorial/docs/lesson_14/>Урок 14. Конечные автоматы в aiogram, разбиваем логику по файлам</a></li></ul></nav></aside><div class=book-page><header class="align-center justify-between book-header"><label for=menu-control><img src=/telegram-tutorial/svg/menu.svg alt=Menu></label></header><header class=markdown><h1>Урок 6. Собираем аналитику при помощи Botan (неактуально)</h1></header><article class=markdown><div class=book-expand><label><div class="book-expand-head flex justify-between"><span>⚠️ Важно!</span>
<span>↕</span></div><input type=checkbox style=display:none><div class="book-expand-content markdown-inner">Сервис Botan в середине 2018 года <a href=https://github.com/botanio/sdk>был отключен</a> и больше не работает. Урок оставлен исключительно для истории.</div></label></div><p>Вы наверняка уже видели <a href=https://vk.com/wall-90229462_2725>новость</a> о такой чудесной системе аналитики для ботов Telegram, как <a href=https://github.com/botanio/sdk>Botan</a>. Сам я ей пользуюсь уже несколько месяцев, поэтому могу с уверенностью сказать, что штука эта очень полезная и качественная. Сегодня мы научимся пользоваться Ботаном в наших Telegram-ботах. В данном уроке будет рассмотрено только подключение бота к Botan через веб-интерфейс, всё, что касается их бота, вы можете рассмотреть самостоятельно.</p><h2 id=регистрируемся-в-yandex-appmetrica>Регистрируемся в Yandex AppMetrica</h2><p>Первое, что необходимо сделать, это перейти по адресу <a href=https://appmetrica.yandex.com>https://appmetrica.yandex.com</a> и войти при помощи своей Яндекс-почты. После того, как вы попадете в панель управления, нажимайте на &ldquo;+ Добавить приложение&rdquo;. В появившемся окне нужно ввести ник бота (вместе с &ldquo;собакой&rdquo;), прочитать условия пользовательского соглашения и согласиться с ними, поставив галку напротив соответствующего пункта.</p><p><center><figure style="padding:.25rem;margin:1rem 0"><img style=max-width:100%;height:auto src=/telegram-tutorial/images/l6_1.jpg alt="Добавление приложения"><figcaption><h4><i>Добавление приложения</i></h4></figcaption></figure></center></p><p>После нажатия на &ldquo;Добавить приложение&rdquo;, появится окошко, в котором нас интересует поле API Key. Скопируйте его куда-нибудь в надёжное место, скоро этот ключ нам понадобится.</p><p><center><figure style="padding:.25rem;margin:1rem 0"><img style=max-width:100%;height:auto src=/telegram-tutorial/images/l6_2.jpg alt="API Key"><figcaption><h4><i>API Key</i></h4></figcaption></figure></center></p><h2 id=интегрируем-аналитику-в-нашего-бота>Интегрируем аналитику в нашего бота</h2><p>Теперь осталось начать сбор статистики по нашему боту! В качестве примера создадим ещё одного, в котором будет 2 команды: <strong>/random</strong> и <strong>/yesorno</strong>. Первая будет выводить случайное число от 1 до 10, а вторая - &ldquo;да&rdquo; или &ldquo;нет&rdquo;.
Итак, для начала займемся файлом <code>config.py</code>. Помимо токена самого бота, создадим переменную <code>botan_key</code>, в которую запишем полученный ранее API Key.
Хорошо, с конфигом закончим. Создадим файл botan.py. Кто-то скажет, мол, можно же взять готовый из <a href=https://github.com/botanio/sdk>соответствующего репозитория</a>. Так-то да, но при работе с <a href=https://github.com/eternnoir/pyTelegramBotAPI>pyTelegramBotAPI</a>, мне пришлось внести в него некоторые дополнения. Сам файл довольно большой, чтобы приводить его полностью здесь, поэтому отсылаю вас к <a href=https://github.com/MasterGroosha/telegram-tutorial/blob/master/lesson_06/botan.py>своему репозиторию</a>, где его можно просмотреть.<br>Функция <code>make_json</code> получает на вход объект <code>Message</code> и выбирает из него необходимые поля. В принципе, можно собирать статистику по чему угодно, т.е. можно смотреть, пользователь с каким ID или ником сколько раз вызвал ту или иную команду, в каком чате чаще используют бота и т.д.<br>В данном примере я оставлю сбор различных параметров, но в коде будут указания, что делать, если нужно просто количество использований той или иной команды.</p><p>Создадим две функции:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-none data-lang=none>@bot.message_handler(commands=[&#39;random&#39;])
def cmd_random(message):
    bot.send_message(message.chat.id, random.randint(1, 10))
    # Если не нужно собирать ничего, кроме количества использований, замените третий аргумент message на None
    botan.track(config.botan_key, message.chat.id, message, &#39;Случайное число&#39;)
    return


@bot.message_handler(commands=[&#39;yesorno&#39;])
def cmd_yesorno(message):
    bot.send_message(message.chat.id, random.choice(strings))
    # Если не нужно собирать ничего, кроме количества использований, замените третий аргумент message на None
    botan.track(config.botan_key, message.chat.id, message, &#39;Да или нет&#39;)
    return</code></pre></div><p>Не забудьте импортировать стандартный модуль <code>random</code> и написать после него <code>random.seed()</code> для инициализации генератора!<br>Также обратите внимание на строчку <code>botan.track(...)</code>. Именно эта строка и отвечает за отправку статистики. Первый аргумент - ключ, полученный при регистрации бота в Ботане, второй аргумент - chat.id, получаемый в сообщении. Третий аргумент - объект сообщения, из которого вытягивается необходимая информация, а последний - что-то типа метки, описывающая команду.<br>В первой строке функции <code>cmd_yesorno</code> есть вызов <code>random.choice(strings)</code>, это выбор случайного элемента из массива, в нашем случае содержащего всего 2 элемента: строку &ldquo;да&rdquo; и строку &ldquo;нет&rdquo;.</p><p>Собственно, всё. Дописываем нужные строки кода, как и раньше и запускаем бота! Несколько раз используем команды <strong>/random</strong> и <strong>/yesorno</strong>, подождем пару минут и заглянем в статистику, выбрав бота в Метрике, пункт &ldquo;Приложение&rdquo; - &ldquo;События&rdquo;:</p><p><center><figure style="padding:.25rem;margin:1rem 0"><img style=max-width:100%;height:auto src=/telegram-tutorial/images/l6_3.jpg alt="Просмотр статистики"><figcaption><h4><i>Просмотр статистики</i></h4></figcaption></figure></center></p><p>Как видите, всё прекрасно работает!</p><p><a href=/telegram-tutorial/docs/lesson_05/ class=book-btn style=float:left>← Урок №5</a>
<a href=/telegram-tutorial/docs/lesson_07/ class=book-btn style=float:right>Урок №7 →</a></p></article></div><aside class="book-toc level-3 fixed"><nav id=TableOfContents><ul><li><ul><li><a href=#регистрируемся-в-yandex-appmetrica>Регистрируемся в Yandex AppMetrica</a></li><li><a href=#интегрируем-аналитику-в-нашего-бота>Интегрируем аналитику в нашего бота</a></li></ul></li></ul></nav></aside></main></body></html>