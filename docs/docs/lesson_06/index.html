<!doctype html><html lang=ru><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Собираем аналитику при помощи Botan (неактуально)"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Пишем ботов для Telegram на языке Python"><meta property="og:type" content="article"><meta property="og:description" content="Урок 6: Собираем аналитику при помощи Botan (неактуально)"><meta property="og:url" content="https://mastergroosha.github.io/telegram-tutorial/docs/lesson_06/"><meta property="og:site_name" content="Пишем ботов для Telegram на языке Python"><meta property="og:image" content="https://mastergroosha.github.io/telegram-tutorial/bot_logo.png"><title>Урок 6: Собираем аналитику при помощи Botan (неактуально) | Пишем ботов для Telegram на языке Python</title><link rel=manifest href=/telegram-tutorial/manifest.json><link rel=icon href=/telegram-tutorial/favicon.png type=image/x-icon><link rel=stylesheet href=/telegram-tutorial/book.min.6df681b0bb21155cba49f6078e3559216772d8e03e780d240c73ea21817ed5e5.css integrity="sha256-bfaBsLshFVy6SfYHjjVZIWdy2OA+eA0kDHPqIYF+1eU="></head><body><input type=checkbox class=hidden id=menu-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/telegram-tutorial><span>Пишем ботов для Telegram на языке Python</span></a></h2><ul><li class=book-section-flat><span>pyTelegramBotAPI</span><ul><li><a href=/telegram-tutorial/docs/pyTelegramBotAPI/lesson_00/>Урок 0. Подготовка рабочего места в Windows и Linux. Virtual Environment (venv). Ответы на вопросы</a></li><li><a href=/telegram-tutorial/docs/lesson_01/>Урок 1. Введение, простой echo-бот</a></li><li><a href=/telegram-tutorial/docs/lesson_02/>Урок 2. «Угадай мелодию». Подготовка</a></li><li><a href=/telegram-tutorial/docs/lesson_03/>Урок 3. «Угадай мелодию». Завершаем бота</a></li><li><a href=/telegram-tutorial/docs/lesson_04/>Урок 4. Вебхуки</a></li><li><a href=/telegram-tutorial/docs/lesson_05/>Урок 5. Автопостинг в каналы</a></li><li><a href=/telegram-tutorial/docs/lesson_06/ class=active>Урок 6. Собираем аналитику при помощи Botan (неактуально)</a></li><li><a href=/telegram-tutorial/docs/lesson_07/>Урок 7. Встраиваемые боты (Inline)</a></li><li><a href=/telegram-tutorial/docs/lesson_08/>Урок 8. Bot API v2: Кнопки и редактирование сообщений</a></li><li><a href=/telegram-tutorial/docs/lesson_09/>Урок 9. Bot API v2: Специальные кнопки, опять редактирование сообщений, кэшированный инлайн</a></li><li><a href=/telegram-tutorial/docs/lesson_10/>Урок 10. Bot API v3. Автоматизируем работу в группах</a></li><li><a href=/telegram-tutorial/docs/lesson_11/>Урок 11. Ведём (более-менее) осмысленные диалоги. Конечные автоматы</a></li><li><a href=/telegram-tutorial/docs/lesson_12/>Урок 12. Запускаем несколько ботов на одном сервере</a></li></ul></li><li class=book-section-flat><span>aiogram</span><ul><li><a href=/telegram-tutorial/docs/lesson_13/>Урок 13. Опросы v2.0</a></li><li><a href=/telegram-tutorial/docs/lesson_14/>Урок 14. Конечные автоматы в aiogram, разбиваем логику по файлам</a></li></ul></li></ul><ul><li><a href=/telegram-tutorial/posts/></a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/telegram-tutorial/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Урок 6</strong>
<label for=toc-control><img src=/telegram-tutorial/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><input type=checkbox class=hidden id=toc-control><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#-важно>⚠️ Важно!</a></li><li><a href=#описание>Описание</a></li><li><a href=#регистрируемся-в-yandex-appmetrica>Регистрируемся в Yandex AppMetrica</a></li><li><a href=#интегрируем-аналитику-в-нашего-бота>Интегрируем аналитику в нашего бота</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1>Собираем аналитику при помощи Botan (неактуально)</h1><p><h2 id=-важно>⚠️ Важно!</h2><p>Сервис Botan в середине 2018 года <a href=https://github.com/botanio/sdk>был отключен</a> и больше не работает. Урок оставлен исключительно для истории.</p><h2 id=описание>Описание</h2><p>Вы наверняка уже видели <a href=https://vk.com/wall-90229462_2725>новость</a> о такой чудесной системе аналитики для ботов Telegram, как <a href=https://github.com/botanio/sdk>Botan</a>. Сам я ей пользуюсь уже несколько месяцев, поэтому могу с уверенностью сказать, что штука эта очень полезная и качественная. Сегодня мы научимся пользоваться Ботаном в наших Telegram-ботах. В данном уроке будет рассмотрено только подключение бота к Botan через веб-интерфейс, всё, что касается их бота, вы можете рассмотреть самостоятельно.</p><h2 id=регистрируемся-в-yandex-appmetrica>Регистрируемся в Yandex AppMetrica</h2><p>Первое, что необходимо сделать, это перейти по адресу <a href=https://appmetrica.yandex.com>https://appmetrica.yandex.com</a> и войти при помощи своей Яндекс-почты. После того, как вы попадете в панель управления, нажимайте на &ldquo;+ Добавить приложение&rdquo;. В появившемся окне нужно ввести ник бота (вместе с &ldquo;собакой&rdquo;), прочитать условия пользовательского соглашения и согласиться с ними, поставив галку напротив соответствующего пункта.</p><center><img src=https://mastergroosha.github.io/telegram-tutorial//images/l6_1.jpg></center>
<center><i>Добавление приложения</i></center><p>После нажатия на &ldquo;Добавить приложение&rdquo;, появится окошко, в котором нас интересует поле API Key. Скопируйте его куда-нибудь в надёжное место, скоро этот ключ нам понадобится.</p><center><img src=https://mastergroosha.github.io/telegram-tutorial//images/l6_2.jpg></center>
<center><i>Ключ API</i></center><h2 id=интегрируем-аналитику-в-нашего-бота>Интегрируем аналитику в нашего бота</h2><p>Теперь осталось начать сбор статистики по нашему боту! В качестве примера создадим ещё одного, в котором будет 2 команды: <strong>/random</strong> и <strong>/yesorno</strong>. Первая будет выводить случайное число от 1 до 10, а вторая - &ldquo;да&rdquo; или &ldquo;нет&rdquo;.
Итак, для начала займемся файлом <code>config.py</code>. Помимо токена самого бота, создадим переменную <code>botan_key</code>, в которую запишем полученный ранее API Key.
Хорошо, с конфигом закончим. Создадим файл botan.py. Кто-то скажет, мол, можно же взять готовый из <a href=https://github.com/botanio/sdk>соответствующего репозитория</a>. Так-то да, но при работе с <a href=https://github.com/eternnoir/pyTelegramBotAPI>pyTelegramBotAPI</a>, мне пришлось внести в него некоторые дополнения. Сам файл довольно большой, чтобы приводить его полностью здесь, поэтому отсылаю вас к <a href=https://github.com/MasterGroosha/telegram-tutorial/blob/master/lesson_06/botan.py>своему репозиторию</a>, где его можно просмотреть.<br>Функция <code>make_json</code> получает на вход объект <code>Message</code> и выбирает из него необходимые поля. В принципе, можно собирать статистику по чему угодно, т.е. можно смотреть, пользователь с каким ID или ником сколько раз вызвал ту или иную команду, в каком чате чаще используют бота и т.д.<br>В данном примере я оставлю сбор различных параметров, но в коде будут указания, что делать, если нужно просто количество использований той или иной команды.</p><p>Создадим две функции:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>@bot.message_handler(commands=[<span style=color:#a31515>&#39;random&#39;</span>])
<span style=color:#00f>def</span> cmd_random(message):
    bot.send_message(message.chat.id, random.randint(1, 10))
    <span style=color:green># Если не нужно собирать ничего, кроме количества использований, замените третий аргумент message на None</span>
    botan.track(config.botan_key, message.chat.id, message, <span style=color:#a31515>&#39;Случайное число&#39;</span>)
    <span style=color:#00f>return</span>


@bot.message_handler(commands=[<span style=color:#a31515>&#39;yesorno&#39;</span>])
<span style=color:#00f>def</span> cmd_yesorno(message):
    bot.send_message(message.chat.id, random.choice(strings))
    <span style=color:green># Если не нужно собирать ничего, кроме количества использований, замените третий аргумент message на None</span>
    botan.track(config.botan_key, message.chat.id, message, <span style=color:#a31515>&#39;Да или нет&#39;</span>)
    <span style=color:#00f>return</span>
</code></pre></div><p>Не забудьте импортировать стандартный модуль <code>random</code> и написать после него <code>random.seed()</code> для инициализации генератора!<br>Также обратите внимание на строчку <code>botan.track(...)</code>. Именно эта строка и отвечает за отправку статистики. Первый аргумент - ключ, полученный при регистрации бота в Ботане, второй аргумент - chat.id, получаемый в сообщении. Третий аргумент - объект сообщения, из которого вытягивается необходимая информация, а последний - что-то типа метки, описывающая команду.<br>В первой строке функции <code>cmd_yesorno</code> есть вызов <code>random.choice(strings)</code>, это выбор случайного элемента из массива, в нашем случае содержащего всего 2 элемента: строку &ldquo;да&rdquo; и строку &ldquo;нет&rdquo;.</p><p>Собственно, всё. Дописываем нужные строки кода, как и раньше и запускаем бота! Несколько раз используем команды <strong>/random</strong> и <strong>/yesorno</strong>, подождем пару минут и заглянем в статистику, выбрав бота в Метрике, пункт &ldquo;Приложение&rdquo; - &ldquo;События&rdquo;:</p><center><img src=https://mastergroosha.github.io/telegram-tutorial//images/l6_3.jpg></center>
<center><i>Просмотр статистики</i></center><p>Как видите, всё прекрасно работает!</p><p><a href=/telegram-tutorial/docs/lesson_05/ class=book-btn style=float:left>← Урок №5</a>
<a href=/telegram-tutorial/docs/lesson_07/ class=book-btn style=float:right>Урок №7 →</a></p></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><ul><li><a href=#-важно>⚠️ Важно!</a></li><li><a href=#описание>Описание</a></li><li><a href=#регистрируемся-в-yandex-appmetrica>Регистрируемся в Yandex AppMetrica</a></li><li><a href=#интегрируем-аналитику-в-нашего-бота>Интегрируем аналитику в нашего бота</a></li></ul></li></ul></nav></aside></main></body></html>